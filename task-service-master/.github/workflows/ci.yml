name: Task Service CI/CD

# This workflow is for task-service when in its own repository
# Place this file in: task-service/.github/workflows/ci.yml

on:
  push:
    branches: [main, master, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  repository_dispatch:
    types: [proto-updated] # Triggered when proto repository changes

env:
  AWS_REGION: ap-southeast-1
  ECR_REGISTRY: 158670175038.dkr.ecr.ap-southeast-1.amazonaws.com
  ECR_REPOSITORY: docker
  SERVICE_NAME: task-service
  IMAGE_NAME: task

permissions:
  id-token: write # Required for OIDC authentication
  contents: read # Required to checkout code

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    name: Build and Push Docker Image
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) || github.event_name == 'repository_dispatch'

    steps:
      - name: Display trigger information
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "## ðŸ”„ Triggered by Proto Repository Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Proto Commit:** \`${{ github.event.client_payload.proto_commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit Message:** ${{ github.event.client_payload.proto_commit_message }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.client_payload.changed_files }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changed Files:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ github.event.client_payload.changed_files }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "ðŸ”„ Rebuilding service due to proto file changes..."

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout proto repository
        uses: actions/checkout@v4
        with:
          repository: ws02-project/proto
          path: proto
          token: ${{ secrets.PAT_TOKEN }}

      - name: Debug - Check AWS_ROLE_ARN variable
        run: |
          echo "AWS_ROLE_ARN value: ${{ vars.AWS_ROLE_ARN }}"
          if [ -z "${{ vars.AWS_ROLE_ARN }}" ]; then
            echo "âš ï¸  WARNING: AWS_ROLE_ARN variable is not set!"
            echo "Please add it as a repository variable:"
            echo "Repository â†’ Settings â†’ Secrets and variables â†’ Actions â†’ Variables"
            echo "Name: AWS_ROLE_ARN"
            echo "Value: arn:aws:iam::158670175038:role/registry-github-actions-role"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ startsWith(github.ref, 'refs/tags/v') }}" == "true" ]]; then
            IMAGE_TAG=${GITHUB_REF#refs/tags/v}
          else
            IMAGE_TAG=${GITHUB_SHA::8}
          fi
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_NAME }}-$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_latest=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_NAME }}-latest" >> $GITHUB_OUTPUT

      - name: Install dependencies for Trivy scan
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm install --frozen-lockfile || pnpm install

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0' # Don't fail on filesystem scan, just report

      - name: Build Docker image
        env:
          IMAGE_NAME: ${{ steps.meta.outputs.image }}
        run: |
          echo "Building Docker image: $IMAGE_NAME"
          docker build -t $IMAGE_NAME -f Dockerfile .
          docker tag $IMAGE_NAME ${{ steps.meta.outputs.image_latest }}
          # Also tag with a simple local name for Trivy scanning
          docker tag $IMAGE_NAME ${{ env.SERVICE_NAME }}:scan

      - name: Run Trivy image scan (Table output - Show all vulnerabilities)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true # Show results even if vulnerabilities found
        with:
          scan-type: 'image'
          image-ref: '${{ env.SERVICE_NAME }}:scan'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '0' # Don't fail here, just show results

      - name: Run Trivy image scan (Fail on CRITICAL/HIGH)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: '${{ env.SERVICE_NAME }}:scan'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1' # Fail pipeline if CRITICAL or HIGH vulnerabilities found

      - name: Push Docker image to ECR
        env:
          IMAGE_NAME: ${{ steps.meta.outputs.image }}
          IMAGE_LATEST: ${{ steps.meta.outputs.image_latest }}
        run: |
          echo "Pushing Docker image: $IMAGE_NAME"
          docker push $IMAGE_NAME
          docker push $IMAGE_LATEST

      - name: Image details
        run: |
          echo "âœ… Successfully pushed Task Service image:"
          echo "  Image: ${{ steps.meta.outputs.image }}"
          echo "  Latest: ${{ steps.meta.outputs.image_latest }}"

      - name: Trigger deployment update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repository: ws02-project/deployments
          event-type: update-image
          client-payload: |-
            {
              "service": "task-service",
              "image_tag": "${{ steps.meta.outputs.tag }}",
              "image_full": "${{ steps.meta.outputs.image }}",
              "commit_sha": "${{ github.sha }}"
            }
